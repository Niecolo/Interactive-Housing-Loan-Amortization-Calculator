<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Housing Loan Amortization Calculator</title>
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --secondary-color: #10b981;
            --secondary-hover: #059669;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --success-bg: #d1fae5;
            --warning-bg: #fef3c7;
            --info-bg: #dbeafe;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            padding: 40px;
        }

        h1 {
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2rem;
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1rem;
        }

        /* Input Section */
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        label .icon {
            font-size: 1.1rem;
        }

        input, select {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Payment Tracking Section */
        .payment-tracking {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid var(--secondary-color);
        }

        .payment-tracking h3 {
            color: #065f46;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .payment-option {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .payment-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .payment-option h4 {
            color: var(--text-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .payment-option p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .payment-option input {
            width: 100%;
        }

        /* Buttons */
        .btn-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        button {
            border: none;
            padding: 14px 32px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-hover) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #f9fafb;
            border-color: var(--primary-color);
        }

        /* Summary Cards */
        .summary-section {
            display: none;
            margin-bottom: 30px;
        }

        .summary-section.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 5px solid var(--primary-color);
            transition: transform 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-3px);
        }

        .summary-card.success {
            border-left-color: var(--secondary-color);
        }

        .summary-card.warning {
            border-left-color: var(--accent-color);
        }

        .summary-card.danger {
            border-left-color: var(--danger-color);
        }

        .summary-card h3 {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .summary-card .value {
            color: var(--text-primary);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .summary-card .subtext {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        /* Payment Impact Visualization */
        .impact-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }

        .impact-section.active {
            display: block;
        }

        .impact-section h3 {
            color: #92400e;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .impact-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .impact-item .label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .impact-item .value {
            color: var(--secondary-color);
            font-size: 1.4rem;
            font-weight: 700;
        }

        .impact-item .value.negative {
            color: var(--danger-color);
        }

        /* Payment Schedule Table */
        .table-section {
            display: none;
            margin-top: 30px;
        }

        .table-section.active {
            display: block;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h2 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .table-controls select,
        .table-controls input {
            padding: 10px 15px;
            font-size: 0.9rem;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        tr:nth-child(even) {
            background-color: #f9fafb;
        }

        tr:hover {
            background-color: #f3f4f6;
        }

        tr.highlight {
            background-color: #fef3c7 !important;
            font-weight: 600;
        }

        tr.additional-payment-row {
            background-color: #d1fae5 !important;
            border-left: 4px solid var(--secondary-color);
        }

        .positive {
            color: var(--secondary-color);
            font-weight: 600;
        }

        .negative {
            color: var(--danger-color);
            font-weight: 600;
        }

        /* Progress Bar */
        .progress-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            background: #e5e7eb;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, var(--info-bg) 0%, #bfdbfe 100%);
            border-left: 5px solid var(--primary-color);
            padding: 20px;
            margin-top: 30px;
            border-radius: 10px;
        }

        .info-box strong {
            color: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .input-section {
                grid-template-columns: 1fr;
            }

            .btn-container {
                flex-direction: column;
            }

            button {
                width: 100%;
                justify-content: center;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .tooltip:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè° Interactive Housing Loan Calculator</h1>
        <p class="subtitle">Track your payments, visualize savings, and become debt-free faster</p>

        <!-- Loan Details Input -->
        <div class="input-section">
            <div class="input-group">
                <label for="loanAmount"><span class="icon">üí∞</span> Loan Amount (‚Ç±):</label>
                <input type="number" id="loanAmount" value="3000000" min="1000" step="10000">
            </div>

            <div class="input-group">
                <label for="interestRate"><span class="icon">üìä</span> Annual Interest Rate (%):</label>
                <input type="number" id="interestRate" value="6.5" min="0.1" step="0.1" max="25">
            </div>

            <div class="input-group">
                <label for="loanTerm"><span class="icon">üìÖ</span> Loan Term (years):</label>
                <input type="number" id="loanTerm" value="20" min="1" max="50">
            </div>

            <div class="input-group">
                <label for="paymentFrequency"><span class="icon">üîÑ</span> Payment Frequency:</label>
                <select id="paymentFrequency">
                    <option value="monthly">Monthly (12 payments/year)</option>
                    <option value="biweekly">Bi-weekly (26 payments/year)</option>
                    <option value="annually">Annually (1 payment/year)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="startDate"><span class="icon">üìÜ</span> First Payment Date:</label>
                <input type="date" id="startDate">
            </div>
        </div>

        <!-- Payment Tracking Section -->
        <div class="payment-tracking">
            <h3>üí≥ Track Your Additional Principal Payments</h3>
            <div class="payment-options">
                <div class="payment-option">
                    <h4>üîÑ Recurring Extra Payment</h4>
                    <p>Additional amount added to every payment</p>
                    <input type="number" id="recurringExtra" value="0" min="0" step="500" placeholder="‚Ç± per payment">
                </div>

                <div class="payment-option">
                    <h4>üìÖ One-Time Extra Payment</h4>
                    <p>Lump sum payment at a specific date</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="number" id="oneTimeAmount" value="0" min="0" step="1000" placeholder="Amount (‚Ç±)" style="flex: 2;">
                        <input type="date" id="oneTimeDate" style="flex: 1;">
                    </div>
                </div>

                <div class="payment-option">
                    <h4>üìà Annual Increase</h4>
                    <p>Increase extra payment by this amount each year</p>
                    <input type="number" id="annualIncrease" value="0" min="0" step="500" placeholder="‚Ç± per year">
                </div>

                <div class="payment-option">
                    <h4>üéØ Custom Payments</h4>
                    <p>Add multiple custom payments (comma-separated)</p>
                    <input type="text" id="customPayments" placeholder="Month1:Amount1, Month2:Amount2 (e.g., 12:50000, 24:50000)">
                </div>
            </div>
        </div>

        <div class="btn-container">
            <button id="calculateBtn" class="btn-primary">
                <span>üßÆ</span> Calculate Amortization
            </button>
            <button id="resetBtn" class="btn-secondary">
                <span>üîÑ</span> Reset All
            </button>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="progress-section">
            <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span>üìä</span> Loan Payoff Progress
            </h3>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar" style="width: 0%;">0%</div>
            </div>
            <div class="progress-labels">
                <span>Start: <strong id="progressStart">‚Ç±0</strong></span>
                <span>Current Balance: <strong id="progressCurrent">‚Ç±0</strong></span>
                <span>Paid: <strong id="progressPaid">‚Ç±0</strong></span>
            </div>
        </div>

        <!-- Summary Cards -->
        <div id="summarySection" class="summary-section">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>üìã Base Monthly Payment</h3>
                    <div class="value" id="basePayment">‚Ç±0.00</div>
                    <div class="subtext">Without extra payments</div>
                </div>

                <div class="summary-card success">
                    <h3>üíµ Total Interest (Base)</h3>
                    <div class="value" id="baseInterest">‚Ç±0.00</div>
                    <div class="subtext">Original schedule</div>
                </div>

                <div class="summary-card success">
                    <h3>‚úÖ Total Interest (With Extras)</h3>
                    <div class="value" id="totalInterest">‚Ç±0.00</div>
                    <div class="subtext">With your extra payments</div>
                </div>

                <div class="summary-card warning">
                    <h3>üí∞ Interest Saved</h3>
                    <div class="value" id="interestSaved">‚Ç±0.00</div>
                    <div class="subtext">Money kept in your pocket</div>
                </div>

                <div class="summary-card danger">
                    <h3>üìÖ Original Payoff</h3>
                    <div class="value" id="originalDate">-</div>
                    <div class="subtext">Without extra payments</div>
                </div>

                <div class="summary-card success">
                    <h3>üéâ New Payoff Date</h3>
                    <div class="value" id="newDate">-</div>
                    <div class="subtext">With extra payments</div>
                </div>

                <div class="summary-card">
                    <h3>‚ö° Time Saved</h3>
                    <div class="value" id="timeSaved">-</div>
                    <div class="subtext">Years and months</div>
                </div>

                <div class="summary-card">
                    <h3>üìä Total Payments</h3>
                    <div class="value" id="totalPayments">‚Ç±0.00</div>
                    <div class="subtext">Principal + Interest</div>
                </div>
            </div>
        </div>

        <!-- Payment Impact Section -->
        <div id="impactSection" class="impact-section">
            <h3>üìà Impact of Your Extra Payments</h3>
            <div class="impact-grid">
                <div class="impact-item">
                    <div class="label">Total Extra Principal Paid</div>
                    <div class="value" id="totalExtraPaid">‚Ç±0</div>
                </div>
                <div class="impact-item">
                    <div class="label">Payments Reduced By</div>
                    <div class="value" id="paymentsReduced">0</div>
                </div>
                <div class="impact-item">
                    <div class="label">Interest Reduction %</div>
                    <div class="value" id="interestReductionPct">0%</div>
                </div>
                <div class="impact-item">
                    <div class="label">Effective Interest Rate</div>
                    <div class="value" id="effectiveRate">0%</div>
                </div>
            </div>
        </div>

        <!-- Amortization Table Section -->
        <div id="tableSection" class="table-section">
            <div class="table-header">
                <h2><span>üìä</span> Amortization Schedule</h2>
                <div class="table-controls">
                    <select id="viewFilter">
                        <option value="all">Show All Payments</option>
                        <option value="yearly">Yearly Summary</option>
                        <option value="first12">First Year + Last</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    <div id="customRange" style="display: none; gap: 10px;">
                        <input type="number" id="startMonth" placeholder="From" min="1" value="1" style="width: 80px;">
                        <span>to</span>
                        <input type="number" id="endMonth" placeholder="To" min="1" value="12" style="width: 80px;">
                    </div>
                    <button id="exportBtn" class="btn-success">
                        <span>üì•</span> Export CSV
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table id="amortizationTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Payment</th>
                            <th>Extra</th>
                            <th>Principal</th>
                            <th>Interest</th>
                            <th>Total Principal</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="info-box">
            <strong>üí° Pro Tip:</strong> Even small extra payments can significantly reduce your loan term and total interest. 
            For example, adding just ‚Ç±5,000 extra per month on a 20-year loan can save you years of payments and thousands in interest!
            Use the tracking features above to see the impact of different payment strategies.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set default start date to next month
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            document.getElementById('startDate').value = nextMonth.toISOString().split('T')[0];

            // Set one-time payment date to 1 year from start
            const oneYearLater = new Date(nextMonth);
            oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
            document.getElementById('oneTimeDate').value = oneYearLater.toISOString().split('T')[0];

            const calculateBtn = document.getElementById('calculateBtn');
            const resetBtn = document.getElementById('resetBtn');
            const exportBtn = document.getElementById('exportBtn');
            const viewFilter = document.getElementById('viewFilter');
            const customRange = document.getElementById('customRange');
            const startMonth = document.getElementById('startMonth');
            const endMonth = document.getElementById('endMonth');

            let currentSchedule = [];
            let baseSchedule = [];

            calculateBtn.addEventListener('click', calculateAmortization);
            resetBtn.addEventListener('click', resetForm);
            exportBtn.addEventListener('click', exportCSV);
            viewFilter.addEventListener('change', function() {
                customRange.style.display = this.value === 'custom' ? 'flex' : 'none';
                if (currentSchedule.length > 0) {
                    generateTable(currentSchedule, this.value);
                }
            });
            startMonth.addEventListener('change', () => {
                if (currentSchedule.length > 0) generateTable(currentSchedule, viewFilter.value);
            });
            endMonth.addEventListener('change', () => {
                if (currentSchedule.length > 0) generateTable(currentSchedule, viewFilter.value);
            });

            function resetForm() {
                document.getElementById('loanAmount').value = '3000000';
                document.getElementById('interestRate').value = '6.5';
                document.getElementById('loanTerm').value = '20';
                document.getElementById('paymentFrequency').value = 'monthly';
                document.getElementById('recurringExtra').value = '0';
                document.getElementById('oneTimeAmount').value = '0';
                document.getElementById('annualIncrease').value = '0';
                document.getElementById('customPayments').value = '';
                
                document.getElementById('summarySection').classList.remove('active');
                document.getElementById('impactSection').classList.remove('active');
                document.getElementById('tableSection').classList.remove('active');
                document.getElementById('progressSection').classList.remove('active');
            }

            function calculateAmortization() {
                const loanAmount = parseFloat(document.getElementById('loanAmount').value);
                const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
                const loanTerm = parseInt(document.getElementById('loanTerm').value);
                const paymentFrequency = document.getElementById('paymentFrequency').value;
                const startDate = new Date(document.getElementById('startDate').value);
                const recurringExtra = parseFloat(document.getElementById('recurringExtra').value) || 0;
                const oneTimeAmount = parseFloat(document.getElementById('oneTimeAmount').value) || 0;
                const oneTimeDate = new Date(document.getElementById('oneTimeDate').value);
                const annualIncrease = parseFloat(document.getElementById('annualIncrease').value) || 0;
                const customPaymentsStr = document.getElementById('customPayments').value.trim();

                if (isNaN(loanAmount) || isNaN(interestRate) || isNaN(loanTerm)) {
                    alert('Please enter valid numbers for all loan fields.');
                    return;
                }

                // Calculate base schedule (without extra payments)
                baseSchedule = calculateBaseSchedule(loanAmount, interestRate, loanTerm, paymentFrequency, startDate);
                
                // Calculate schedule with extra payments
                currentSchedule = calculateWithExtras(
                    loanAmount, interestRate, loanTerm, paymentFrequency, startDate,
                    recurringExtra, oneTimeAmount, oneTimeDate, annualIncrease, customPaymentsStr
                );

                displayResults(baseSchedule, currentSchedule, loanAmount, paymentFrequency);
            }

            function calculateBaseSchedule(principal, annualRate, termYears, frequency, startDate) {
                let schedule = [];
                let balance = principal;
                let currentDate = new Date(startDate);
                
                const paymentsPerYear = frequency === 'monthly' ? 12 : frequency === 'biweekly' ? 26 : 1;
                const ratePerPeriod = annualRate / paymentsPerYear;
                const totalPayments = termYears * paymentsPerYear;

                const paymentAmount = principal * ratePerPeriod * Math.pow(1 + ratePerPeriod, totalPayments) /
                                     (Math.pow(1 + ratePerPeriod, totalPayments) - 1);

                for (let i = 1; i <= totalPayments && balance > 0.01; i++) {
                    const interestPayment = balance * ratePerPeriod;
                    let principalPayment = paymentAmount - interestPayment;
                    
                    if (principalPayment > balance) principalPayment = balance;
                    const actualPayment = interestPayment + principalPayment;
                    balance -= principalPayment;
                    if (balance < 0) balance = 0;

                    schedule.push({
                        paymentNumber: i,
                        date: new Date(currentDate),
                        payment: actualPayment,
                        extraPayment: 0,
                        principal: principalPayment,
                        interest: interestPayment,
                        totalPrincipal: principal - balance,
                        balance: balance
                    });

                    if (frequency === 'monthly') {
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    } else if (frequency === 'biweekly') {
                        currentDate.setDate(currentDate.getDate() + 14);
                    } else {
                        currentDate.setFullYear(currentDate.getFullYear() + 1);
                    }
                }

                return schedule;
            }

            function calculateWithExtras(principal, annualRate, termYears, frequency, startDate,
                                         recurringExtra, oneTimeAmount, oneTimeDate, annualIncrease, customPaymentsStr) {
                let schedule = [];
                let balance = principal;
                let currentDate = new Date(startDate);
                let totalExtraPaid = 0;
                let currentAnnualIncrease = 0;
                let lastYear = -1;

                // Parse custom payments
                const customPayments = {};
                if (customPaymentsStr) {
                    const pairs = customPaymentsStr.split(',');
                    pairs.forEach(pair => {
                        const [month, amount] = pair.split(':').map(s => parseFloat(s.trim()));
                        if (!isNaN(month) && !isNaN(amount)) {
                            customPayments[month] = amount;
                        }
                    });
                }

                const paymentsPerYear = frequency === 'monthly' ? 12 : frequency === 'biweekly' ? 26 : 1;
                const ratePerPeriod = annualRate / paymentsPerYear;
                const baseTotalPayments = termYears * paymentsPerYear;

                const basePayment = principal * ratePerPeriod * Math.pow(1 + ratePerPeriod, baseTotalPayments) /
                                   (Math.pow(1 + ratePerPeriod, baseTotalPayments) - 1);

                let paymentNumber = 1;
                const maxPayments = baseTotalPayments + 120; // Safety limit

                while (balance > 0.01 && paymentNumber <= maxPayments) {
                    const interestPayment = balance * ratePerPeriod;
                    let extraThisPayment = recurringExtra + currentAnnualIncrease;

                    // Check for custom payment
                    if (customPayments[paymentNumber]) {
                        extraThisPayment += customPayments[paymentNumber];
                    }

                    // Check for one-time payment
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const oneTimeDateStr = oneTimeDate.toISOString().split('T')[0];
                    if (dateStr >= oneTimeDateStr && oneTimeAmount > 0 && !oneTimeDate._applied) {
                        extraThisPayment += oneTimeAmount;
                        oneTimeDate._applied = true;
                    }

                    let principalPayment = basePayment - interestPayment + extraThisPayment;
                    
                    if (principalPayment > balance) principalPayment = balance;
                    const actualPayment = interestPayment + principalPayment;
                    const actualExtra = Math.min(extraThisPayment, principalPayment);
                    balance -= principalPayment;
                    totalExtraPaid += actualExtra;
                    if (balance < 0) balance = 0;

                    schedule.push({
                        paymentNumber: paymentNumber,
                        date: new Date(currentDate),
                        payment: actualPayment,
                        extraPayment: actualExtra,
                        principal: principalPayment,
                        interest: interestPayment,
                        totalPrincipal: principal - balance,
                        balance: balance
                    });

                    // Apply annual increase
                    const currentYear = currentDate.getFullYear();
                    if (currentYear !== lastYear && annualIncrease > 0) {
                        currentAnnualIncrease += annualIncrease;
                        lastYear = currentYear;
                    }

                    if (frequency === 'monthly') {
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    } else if (frequency === 'biweekly') {
                        currentDate.setDate(currentDate.getDate() + 14);
                    } else {
                        currentDate.setFullYear(currentDate.getFullYear() + 1);
                    }

                    paymentNumber++;
                    if (balance <= 0) break;
                }

                return schedule;
            }

            function displayResults(base, current, loanAmount, frequency) {
                const baseTotalPayments = base.reduce((sum, row) => sum + row.payment, 0);
                const baseTotalInterest = baseTotalPayments - loanAmount;
                
                const currentTotalPayments = current.reduce((sum, row) => sum + row.payment, 0);
                const currentTotalInterest = currentTotalPayments - loanAmount - current.reduce((sum, row) => sum + row.extraPayment, 0);
                const totalExtraPaid = current.reduce((sum, row) => sum + row.extraPayment, 0);
                const interestSaved = baseTotalInterest - currentTotalInterest;

                const baseFinalDate = base[base.length - 1]?.date || new Date();
                const currentFinalDate = current[current.length - 1]?.date || new Date();

                const paymentsPerYear = frequency === 'monthly' ? 12 : frequency === 'biweekly' ? 26 : 1;
                const paymentsReduced = base.length - current.length;
                const yearsSaved = paymentsReduced / paymentsPerYear;
                const yearsSavedWhole = Math.floor(Math.abs(yearsSaved));
                const monthsSaved = Math.round((Math.abs(yearsSaved) - yearsSavedWhole) * 12);

                // Update summary cards
                document.getElementById('basePayment').textContent = formatCurrency(base[0]?.payment || 0);
                document.getElementById('baseInterest').textContent = formatCurrency(baseTotalInterest);
                document.getElementById('totalInterest').textContent = formatCurrency(currentTotalInterest);
                document.getElementById('interestSaved').textContent = formatCurrency(interestSaved);
                document.getElementById('originalDate').textContent = formatDate(baseFinalDate);
                document.getElementById('newDate').textContent = formatDate(currentFinalDate);
                document.getElementById('timeSaved').textContent = `${yearsSavedWhole}y ${monthsSaved}m`;
                document.getElementById('totalPayments').textContent = formatCurrency(currentTotalPayments);

                // Update impact section
                document.getElementById('totalExtraPaid').textContent = formatCurrency(totalExtraPaid);
                document.getElementById('paymentsReduced').textContent = Math.max(0, paymentsReduced);
                const interestReductionPct = baseTotalInterest > 0 ? ((interestSaved / baseTotalInterest) * 100) : 0;
                document.getElementById('interestReductionPct').textContent = interestReductionPct.toFixed(1) + '%';
                
                // Calculate effective rate
                const totalYears = current.length / paymentsPerYear;
                const effectiveRate = totalYears > 0 ? ((currentTotalInterest / loanAmount) / totalYears * 100) : 0;
                document.getElementById('effectiveRate').textContent = effectiveRate.toFixed(2) + '%';

                // Update progress bar
                const paidPercent = ((loanAmount - current[current.length - 1]?.balance) / loanAmount) * 100;
                document.getElementById('progressBar').style.width = Math.min(100, paidPercent) + '%';
                document.getElementById('progressBar').textContent = Math.min(100, paidPercent).toFixed(1) + '%';
                document.getElementById('progressStart').textContent = formatCurrency(loanAmount);
                document.getElementById('progressCurrent').textContent = formatCurrency(current[current.length - 1]?.balance || 0);
                document.getElementById('progressPaid').textContent = formatCurrency(loanAmount - (current[current.length - 1]?.balance || 0));

                // Show sections
                document.getElementById('summarySection').classList.add('active');
                document.getElementById('impactSection').classList.add('active');
                document.getElementById('tableSection').classList.add('active');
                document.getElementById('progressSection').classList.add('active');

                // Generate table
                generateTable(current, 'first12');
            }

            function generateTable(schedule, filter) {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                let rowsToShow = [];
                
                if (filter === 'all') {
                    rowsToShow = schedule;
                } else if (filter === 'yearly') {
                    // Group by year
                    const yearlyData = {};
                    schedule.forEach(row => {
                        const year = row.date.getFullYear();
                        if (!yearlyData[year]) {
                            yearlyData[year] = {
                                payment: 0, extra: 0, principal: 0, interest: 0, 
                                balance: row.balance, count: 0, lastDate: row.date
                            };
                        }
                        yearlyData[year].payment += row.payment;
                        yearlyData[year].extra += row.extraPayment;
                        yearlyData[year].principal += row.principal;
                        yearlyData[year].interest += row.interest;
                        yearlyData[year].count++;
                        yearlyData[year].lastDate = row.date;
                    });
                    
                    Object.entries(yearlyData).forEach(([year, data], idx) => {
                        rowsToShow.push({
                            paymentNumber: `Year ${idx + 1}`,
                            date: data.lastDate,
                            payment: data.payment,
                            extraPayment: data.extra,
                            principal: data.principal,
                            interest: data.interest,
                            totalPrincipal: schedule.find(r => r.date.getFullYear() === parseInt(year) && r.paymentNumber === data.count)?.totalPrincipal || 0,
                            balance: data.balance,
                            isYearly: true
                        });
                    });
                } else if (filter === 'first12') {
                    rowsToShow = [...schedule.slice(0, 12)];
                    if (schedule.length > 13) {
                        rowsToShow.push({ isLast: true });
                        rowsToShow.push(schedule[schedule.length - 1]);
                    } else if (schedule.length > 12) {
                        rowsToShow.push(schedule[schedule.length - 1]);
                    }
                } else if (filter === 'custom') {
                    const start = parseInt(startMonth.value) - 1;
                    const end = parseInt(endMonth.value);
                    rowsToShow = schedule.slice(start, end);
                }

                rowsToShow.forEach((row, index) => {
                    if (row.isLast) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="8" style="text-align: center; padding: 15px; color: #6b7280;">... ${schedule.length - rowsToShow.length + index} payments omitted ...</td>`;
                        tbody.appendChild(tr);
                        return;
                    }

                    const tr = document.createElement('tr');
                    if (row.isYearly) tr.style.background = '#f0fdf4';
                    if (row.extraPayment > 0) tr.classList.add('additional-payment-row');

                    tr.innerHTML = `
                        <td>${row.paymentNumber}</td>
                        <td>${formatDate(row.date)}</td>
                        <td>${formatCurrency(row.payment)}</td>
                        <td class="${row.extraPayment > 0 ? 'positive' : ''}">${row.extraPayment > 0 ? formatCurrency(row.extraPayment) : '-'}</td>
                        <td class="positive">${formatCurrency(row.principal)}</td>
                        <td>${formatCurrency(row.interest)}</td>
                        <td class="positive">${formatCurrency(row.totalPrincipal)}</td>
                        <td>${formatCurrency(row.balance)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function exportCSV() {
                if (currentSchedule.length === 0) {
                    alert('Please calculate the amortization first.');
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Payment #,Date,Payment,Extra Payment,Principal,Interest,Total Principal,Remaining Balance\n";

                currentSchedule.forEach(row => {
                    csvContent += `${row.paymentNumber},${row.date.toISOString().split('T')[0]},${row.payment},${row.extraPayment},${row.principal},${row.interest},${row.totalPrincipal},${row.balance}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `amortization_schedule_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function formatCurrency(amount) {
                return '‚Ç±' + amount.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function formatDate(date) {
                if (!(date instanceof Date) || isNaN(date)) return '-';
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }
        });
    </script>
</body>
</html>
